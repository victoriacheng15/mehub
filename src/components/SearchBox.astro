---
// SearchBox component for blog search
---

<div class="mb-8">
	<input
		type="text"
		id="blog-search"
		placeholder="Search blog posts..."
		class="focus:ring-secondary-300 w-full rounded border border-gray-300 bg-slate-100 px-4 py-2 text-slate-900 placeholder-gray-500 focus:ring-2 focus:outline-none"
	/>
</div>

<script>
	interface BlogPost {
		title: string;
		slug: string;
		summary: string;
		tags: string[];
		date: string;
	}

	let allPosts: BlogPost[] = [];
	let searchInput: HTMLInputElement | null = null;
	let postsContainer: Element | null = null;
	let paginationElement: Element | null = null;

	// Fetch search index on page load
	async function loadSearchIndex() {
		try {
			const response = await fetch("/search-index.json");
			allPosts = await response.json();
		} catch (error) {
			console.error("Failed to load search index:", error);
			allPosts = [];
		}
	}

	// Simple search function - matches keyword in title, summary, or tags
	function filterPosts(keyword: string): BlogPost[] {
		if (!keyword.trim()) {
			return allPosts;
		}

		const query = keyword.toLowerCase();
		return allPosts.filter((post) => {
			const titleMatch = post.title.toLowerCase().includes(query);
			const summaryMatch = post.summary.toLowerCase().includes(query);
			const tagsMatch = post.tags.some((tag) => tag.toLowerCase().includes(query));
			return titleMatch || summaryMatch || tagsMatch;
		});
	}

	// Format date
	function formatDate(dateStr: string): string {
		return new Date(dateStr).toLocaleDateString("en-US", {
			year: "numeric",
			month: "short",
			day: "numeric",
		});
	}

	// Update the displayed posts
	function updateDisplay(results: BlogPost[], isSearchActive: boolean) {
		if (!postsContainer) return;

		// Hide pagination when search is active
		if (paginationElement) {
			paginationElement.style.display = isSearchActive ? "none" : "block";
		}

		if (results.length === 0) {
			postsContainer.innerHTML =
				'<p class="text-gray-500 py-8">No blog posts found. Try a different search term.</p>';
			return;
		}

		// Re-render posts with styling matching BlogPreview
		postsContainer.innerHTML = results
			.map(
				(post) => `
      <article class="card">
        <header class="flex flex-col gap-2">
          <time datetime="${new Date(post.date).toISOString()}">${formatDate(post.date)}</time>
          <h2>
            <a href="/blog/${post.slug}" class="card-link">
              ${post.title}
            </a>
          </h2>
        </header>
        <p class="mt-3 mb-4">${post.summary}</p>
        ${
					post.tags.length > 0
						? `<div class="flex gap-2 flex-wrap">
                ${post.tags.map((tag) => `<a href="/tags/${tag}" class="tag">#${tag}</a>`).join("")}
              </div>`
						: ""
				}
      </article>
    `,
			)
			.join("");
	}

	// Initialize search functionality
	async function initSearch() {
		searchInput = document.getElementById("blog-search") as HTMLInputElement;
		postsContainer = document.querySelector("section.grid");
		paginationElement = document.querySelector("nav[aria-label]");

		if (!searchInput || !postsContainer) return;

		// Load posts if not already loaded
		if (allPosts.length === 0) {
			await loadSearchIndex();
		}

		// Handle input changes
		searchInput.addEventListener("input", (e) => {
			const keyword = (e.target as HTMLInputElement).value;
			const isSearchActive = keyword.trim().length > 0;

			if (isSearchActive) {
				// Show search results when user types
				const results = filterPosts(keyword);
				updateDisplay(results, true);
			} else {
				// Show pagination when search is empty - don't modify DOM
				if (paginationElement) {
					paginationElement.style.display = "block";
				}
			}
		});

		// Clear search on initial load (pagination stays visible)
		searchInput.value = "";
	}

	// Run on page load and on navigation
	document.addEventListener("astro:page-load", initSearch);

	// Also run immediately if DOM is ready (fallback for non-transition navigations)
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initSearch);
	} else {
		initSearch();
	}
</script>
